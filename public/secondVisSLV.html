<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js Bar Chart</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .button {
            background-color: #2C666E;
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="buttons"></div>
    <div id="chart"></div>

<script>
    // Load data from CSV
    // Load the data from the CSV file
    
    // Assuming you have already imported D3.js and created an SVG container

    // Load the data from the CSV file
    d3.csv("2-distributions_by_migration_status.csv").then(function(data) {
      // Replace this with your actual list of columns
      var column_list = [
        { name: "avg_log_income", type: "numerical" },
        // { name: "log_income_per_capita", type: "numerical" }
      ];

      // var legends = {
      //   avg_log_income: "Average Monthly Log Income",
      //   log_income_per_capita: "Log Income Per Capita"
      // };


      var df = data.filter(function(d) {
            return d.country === "SLV";
        });

      // var filteredData = df.filter(function(d) {
      //     console.log(d.income_sufficiency_6m);

      //     return (d.income_satisfaction >= 1 && d.income_satisfaction <= 4) && (d.income_sufficiency_6m >= 1 && d.income_sufficiency_6m <= 5) ;
      // });

      // Filter the data based on migrated_yn
      var migrated_0 = df.filter(function(d) {
        return d.migrated_yn === "0";
      });

      var migrated_1 = df.filter(function(d) {
        return d.migrated_yn === "1";
      });

      // Set the number of bins
      var num_bins = 20;

      // Create SVG element
      // var svg = d3.select("body")
      //   .append("svg")
      //   .attr("width", 2000)
      //   .attr("height", 400);

      var svg = d3.select("body")
        .append("svg")
        .attr("width", 2000)
        .attr("height", 2000);

      // var svg2 = d3.select("body")
      //   .append("svg")
      //   .attr("width", 400)
      //   .attr("height", 400);


      // Create scales for x and y axes
      var xScale = d3.scaleLinear()
        .domain([0, num_bins])
        .range([0, 600]);

      var yScale = d3.scaleLinear()
        .domain([0, 200])
        .range([300, 0]);

        var yScale2 = d3.scaleLinear()
        .domain([0, 100])
        .range([300, 0]);
      
        console.log(d3.max(migrated_0, function(d) { 
          return +d.avg_log_income; 
        }));

      // Create histograms for each column
      column_list.forEach(function(column, i) {

        if (column.type === "numerical") {
          // Calculate the global min and max for each column across both subplots
          var global_min = Math.min(
            d3.min(migrated_0, function(d) { return +d[column.name]; }),
            d3.min(migrated_1, function(d) { return +d[column.name]; })
          );

          console.log(global_min);

          var global_max = Math.max(
            d3.max(migrated_0, function(d) { return +d[column.name]; }),
            d3.max(migrated_1, function(d) { return +d[column.name]; })
          );

          console.log(global_max);

          // Calculate the bin size using the global min and max
          var bin_size = (global_max - global_min) / num_bins;

          // Create histogram for migrated_0
          var histogram1 = d3.histogram()
            .value(function(d) { return +d[column.name]; })
            .domain([global_min, global_max])
            .thresholds(xScale.ticks(num_bins));

          var bins1 = histogram1(migrated_0);

          // Create histogram for migrated_1
          var histogram2 = d3.histogram()
            .value(function(d) { return +d[column.name]; })
            .domain([global_min, global_max])
            .thresholds(xScale.ticks(num_bins));

          var bins2 = histogram2(migrated_1);

          svg.append("clipPath")
            .attr("id", "clip-path")
            .append("rect")
            .attr("width", 0)
            .attr("height", 300);

          var path2 = svg.append("path")
            .datum(bins2)
            .attr("fill", "none")
            .attr("stroke", "#013220")
            .attr("stroke-opacity", 0.7)
            .attr("stroke-width", 2)
            .attr("d", d3.area()
              .x(function(d) { return xScale((d.x0 + d.x1) / 2); })
              .y0(300)
              .y1(function(d) { return yScale2(d.length); })
              .curve(d3.curveBasis));

          var totalLength2 = path2.node().getTotalLength();

          path2.attr("stroke-dasharray", totalLength2 + " " + totalLength2)
            .attr("stroke-dashoffset", totalLength2);

          path2.transition()
            .duration(2000)
            .attr("stroke-dashoffset", 0)
            .on("end", function() {

                path2.attr("fill", "#013220") // Move fill attribute inside on("end")

                var text = svg.append("text")
                .attr("x", 200)
                .attr("y", 70)
                .attr("text-anchor", "left")
                .style("fill", "#013220")
                .style("font-family", "Arial");

                var words = "Households with individuals"
                var speed = 30; // adjust the speed of typing (milliseconds per character)

                var index = 0;

                function typeText() {
                  if (index < words.length) {
                    text.text(words.substring(0, index + 1));
                    index++;
                    setTimeout(typeText, speed);
                  }
                }

                typeText();

                setTimeout(function () {
                  var text = svg.append("text")
                  .attr("x", 200)
                  .attr("y", 90)
                  .attr("text-anchor", "left")
                  .style("fill", "#013220")
                  .style("font-family", "Arial");
                  var words = "who are able to migrate tend";
                  var speed = 30; // adjust the speed of typing (milliseconds per character)
                  var index = 0;
                  function typeText() {
                    if (index < words.length) {
                      text.text(words.substring(0, index + 1));
                      index++;
                      setTimeout(typeText, speed);
                    }
                  }
                  typeText();

                  setTimeout(function () {
                      var text = svg.append("text")
                      .attr("x", 200)
                      .attr("y", 110)
                      .attr("text-anchor", "left")
                      .style("fill", "#013220")
                      .style("font-family", "Arial");
                      var words = "to have higher incomes.";
                      var speed = 30; // adjust the speed of typing (milliseconds per character)
                      var index = 0;
                      function typeText() {
                        if (index < words.length) {
                          text.text(words.substring(0, index + 1));
                          index++;
                          setTimeout(typeText, speed);
                        }
                      }
                      typeText();
                    }, 1200);
                }, 1200);
              });


          svg.append("clipPath")
          .attr("id", "clip-path")
          .append("rect")
          .attr("width", 0)
          .attr("height", 300);

        var path = svg.append("path")
          .datum(bins1)
          .attr("fill", "none")
          .attr("stroke", "#FF0000")
          .attr("stroke-opacity", 0.7)
          .attr("stroke-width", 2)
          .attr("d", d3.area()
            .x(function(d) { return xScale((d.x0 + d.x1) / 2); })
            .y0(300)
            .y1(function(d) { return yScale(d.length); })
            .curve(d3.curveBasis));

        var totalLength = path.node().getTotalLength();

        path.attr("stroke-dasharray", totalLength + " " + totalLength)
          .attr("stroke-dashoffset", totalLength);

        path.transition()
          .duration(2000)
          .delay(5500)
          .attr("stroke-dashoffset", 0)
          .on("end", function() {

              path.attr("fill", "#FF0000") // Move fill attribute inside on("end")

              var text = svg.append("text")
                  .attr("x", 230)
                  .attr("y", 200)
                  .attr("text-anchor", "left")
                  .style("fill", "#FF0000")
                  .style("font-family", "Arial");

              var words = "Households without any migrants tend"
              var speed = 50; // adjust the speed of typing (milliseconds per character)

              var index = 0;

              function typeText() {
                if (index < words.length) {
                  text.text(words.substring(0, index + 1));
                  index++;
                  setTimeout(typeText, speed);
                }
              }

              typeText();

              setTimeout(function () {
                var text = svg.append("text")
                .attr("x", 230)
                .attr("y", 220)
                .attr("text-anchor", "left")
                .style("font-family", "Arial")
                .style("fill", "#FF0000");
                var words = "to belong to lower income groups.";
                var speed = 50; // adjust the speed of typing (milliseconds per character)
                var index = 0;
                function typeText() {
                  if (index < words.length) {
                    text.text(words.substring(0, index + 1));
                    index++;
                    setTimeout(typeText, speed);
                  }
                }
                typeText();
              }, 2000);

            });


               }
        });

      svg.append("g")
        .attr("class", "y-axis")
        .call(d3.axisLeft(yScale));

      svg.append("g")
        .attr("class", "y-axis")
        .call(d3.axisLeft(yScale2));

      // Add x-axis to both subplots
      svg.append("g")
        .attr("class", "x-axis")
        .attr("transform", "translate(0,300)")
        .call(d3.axisBottom(xScale).ticks(num_bins));

      svg.append("g")
        .attr("class", "x-axis")
        .attr("transform", "translate(0,300)")
        .call(d3.axisBottom(xScale).ticks(num_bins));

      // Add titles to both subplots
      // svg.append("text")
      //   .attr("x", 200)
      //   .attr("y", 30)
      //   .attr("text-anchor", "middle")
      //   .text("Households without migrants");

      // svg.append("text")
      //   .attr("x", 200)
      //   .attr("y", 30)
      //   .attr("text-anchor", "middle")
      //   .text("Incomes in households with migrants versus households without migrants ");

      // Add legend
      // var legend = svg.append("g")
      //   .attr("class", "legend")
      //   .attr("transform", "translate(400,10)");

        var legend = svg.append("g")
        .attr("class", "legend")
        .attr("transform", "translate(400,10)");

        // var legend = svg2.append("g")
        // .attr("class", "legend")
        // .attr("transform", "translate(400,10)");


      legend.append("rect")
        .attr("x", 40)
        .attr("y", 40)
        .attr("width", 15)
        .attr("height", 15)
        .style("fill", "#FF0000")

      legend.append("text")
        .attr("x", 70)
        .attr("y", 51)
        .style('font-family', "Arial")
        .style('font-size', "12px")
        .text("Households without migrants");


      legend.append("rect")
        .attr("x", 40)
        .attr("y", 80)
        .attr("width", 15)
        .attr("height", 15)
        .style("fill", "#013220")

      legend.append("text")
        .attr("x", 70)
        .attr("y", 91)
        .style('font-family', "Arial")
        .style('font-size', "12px")
        .text("Households with migrants");


      // Add title
      // svg.append("text")
      //   .attr("x", 400)
      //   .attr("y", 30)
      //   .attr("text-anchor", "middle")
      //   .text("Households without migrants");

      // svg.append("text")
      //   .attr("x", 800)
      //   .attr("y", 30)
      //   .attr("text-anchor", "middle")
      //   .text("Households with migrants");
    });


    // Function to get counts for each value in a column
    function getCounts(data, columnName) {
        var counts = {};
        data.forEach(function(d) {
            var value = d[columnName];
            if (counts[value]) {
            counts[value]++;
            } else {
            counts[value] = 1;
            }
        });
        return Object.keys(counts).map(function(key) {
            return { value: key, count: counts[key] };
        });
    }
                
</script>
</body>
</html>
