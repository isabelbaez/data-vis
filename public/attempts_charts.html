<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3.js Bar Chart</title>
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <style>
        .button {
            background-color: #2C666E;
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
        }
        #info {
        display: inline-block;
        vertical-align: top;
        padding-left: 20px;
        font-size: 14px;
        }

    </style>
</head>
<body>
    <div id="buttons"></div>
    <div id="chart"></div>
    <div id="info"></div>

    <script>
        // Load data from CSV
        d3.csv("attempts_data_v3.csv").then(data => {
            console.log(data);
            // Replace this with your actual list of columns
            const columnList = ["avg_log_income", "income_per_capita", "mig_ext_cost_total_usd",
                                "debt_amount", "sucess_yn", "institutional_loan_yn"];

            // Define dictionary with y-axis titles
            const legends = {
                "avg_log_income": "Average Log Income",
                "income_per_capita": "Income per Capita",
                "mig_ext_cost_total_usd":"Total Cost of Migration",
                "debt_amount": "Amount of Debt",
                "sucess_yn": "Percentage of Migrants reaching the U.S.",
                "institutional_loan_yn": "Percentage of Migrants w/ Personal Loans"
            };

            const margin = {top: 50, right: 20, bottom: 50, left: 60},
                width = 800 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            // Create the SVG
            const svg = d3.select("#chart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left}, ${margin.top})`);

            // Create the x-axis
            const x = d3.scaleBand()
                .range([0, width])
                .padding(0.2);

            const xAxis = svg.append("g")
                .attr("transform", `translate(0, ${height})`)
                .call(d3.axisBottom(x));

            xAxis.append("text")
                .attr("x", width / 2)
                .attr("y", 35)
                .attr("text-anchor", "middle")
                .attr("fill", "black")
                .text("Number of Migration Attempts");

            // Create the y-axis
            const y = d3.scaleLinear()
                .range([height, 0]);

            const yAxis = svg.append("g")
                .attr("class", "y-axis");

            yAxis.append("text")
                .attr("class", "y-axis-label")
                .attr("x", -height / 2)
                .attr("y", -50)
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("fill", "black");

            let smallestBar, tallestBar;

            // Create the bars
            function update(column) {
    // Filter out empty strings and NaN values
    const filteredData = data.filter(d => d[column] !== "" && !isNaN(+d[column]));

    // Calculate min and max values
    const minValue = d3.min(filteredData, d => +d[column]);
    const maxValue = d3.max(filteredData, d => +d[column]);

    smallestBar = filteredData.find(d => +d[column] === minValue);
    tallestBar = filteredData.find(d => +d[column] === maxValue);

    // Update the y-axis domain and label
    y.domain([0, maxValue]);
    yAxis.transition().duration(1000).call(d3.axisLeft(y));
    yAxis.select(".y-axis-label").text(legends[column]);

    // Update the x-axis domain and redraw the x-axis
    x.domain(filteredData.map(d => d.mig_ext_attempts));
    xAxis.transition().duration(1000).call(d3.axisBottom(x));

    // Update the bars
    const bars = svg.selectAll("rect")
        .data(filteredData, d => d.mig_ext_attempts);

    // Exit bars
    bars.exit()
        .transition()
        .duration(1000)
        .attr("y", height)
        .attr("height", 0)
        .remove();

    // Update existing bars
    bars.attr("x", d => x(d.mig_ext_attempts))
        .attr("width", x.bandwidth())
        .transition()
        .duration(1000)
        .attr("y", d => y(+d[column]))
        .attr("height", d => height - y(+d[column]))
        .attr("fill", d => {
            if (+d[column] === minValue) return "red";
            else if (+d[column] === maxValue) return "green";
            else return "black";
        });

    // Enter new bars
// Enter new bars
bars.enter()
    .append("rect")
    .attr("x", d => x(d.mig_ext_attempts))
    .attr("width", x.bandwidth())
    .attr("y", height)
    .attr("height", 0)
    .attr("class", d => {
        if (d === smallestBar || d === tallestBar) {
            return "clickable";
        }
    })
    .on("click", (event, d) => {
        if (d === smallestBar || d === tallestBar) {
            displayInfo(d);
        }
    })
    .transition()
    .duration(1000)
    .attr("y", d => y(+d[column]))
    .attr("height", d => height - y(+d[column]));

}

function displayInfo(d) {
    const infoDiv = d3.select("#info");
    infoDiv.html(""); // Clear previous content

    const isMin = d === smallestBar;
    const isMax = d === tallestBar;
    if (isMin) {
        infoDiv.append("h3")
            .text("Smallest Bar");
        infoDiv.append("p")
            .html(`<b>Custom message for the smallest bar in ${legends[column]}</b>`);
    } else if (isMax) {
        infoDiv.append("h3")
            .text("Tallest Bar");
        infoDiv.append("p")
            .html(`<b>Custom message for the tallest bar in ${legends[column]}</b>`);
    }

    infoDiv.append("p")
        .html(`<b>Migration Attempts:</b> ${d.mig_ext_attempts}`);
    infoDiv.append("p")
        .html(`<b>${legends[column]}:</b> ${d[column]}`);
}

// Create the buttons
const buttons = d3.select("#buttons").selectAll("button")
    .data(columnList)
    .enter()
    .append("button")
    .attr("class", "button")
    .text(d => legends[d])
    .on("click", (event, d) => update(d)); // Change this line


    // Initialize the chart with the first column
    update(columnList[0]);

});
    </script>
</body>
</html>

